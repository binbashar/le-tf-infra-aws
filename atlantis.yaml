version: 3

# Other settings
automerge: false
delete_source_branch_on_merge: false

# This allows Atlantis to autodiscover projects, however it should also honor
# explicit definitions under the projects key
autodiscover:
  mode: "enabled"
  ignore_paths:
  - config/*

# We need to define a custom workflow because we use our own conventions, so
# for instance we'd like to use the Leverage CLI to run init/plan/apply cmds
workflows:
  default:
    # Customize plan command
    plan:
      steps:
      # We may need to set up things like the build.env or common.tfvars here
      # - run: configure-ref-arch.sh

      # Run init before plan
      - run:
          # command: leverage tf init
          command: tofu init -backend-config=../../config/backend.tfvars
          # output: show

      # You MUST output the plan using -out $PLANFILE because Atlantis expects
      # plans to be in a specific location.
      - run:
          # command: leverage tf plan -input=false -refresh -out $PLANFILE
          command: tofu plan -var-file=../../config/backend.tfvars -var-file=../../../config/common.tfvars -var-file=../../config/account.tfvars -input=false -refresh -out $PLANFILE

    # Customize apply command
    apply:
      steps:
      # Again, you must use the $PLANFILE environment variable.
      - run: leverage tf apply $PLANFILE

# Here we define the projects (or layers) explicitly
projects:
- name: test
  dir: shared/us-east-1/base-tf-backend
  terraform_distribution: opentofu
  terraform_version: 1.6.6
  workflow: default
  delete_source_branch_on_merge: false

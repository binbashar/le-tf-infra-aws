name: Leverage CLI Test

on:
  workflow_dispatch:
    inputs:
      leverage_branch:
        description: "Reference to current Leverage branch to test"
        required: true
        type: string

jobs:
  test_leverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v3

      - name: Clone Leverage
        run: |
          printf "[INFO] Cloning Leverage CLI's repo"
          git clone https://github.com/binbashar/leverage.git

      - name: Build Leverage CLI
        run: |
          printf "[INFO] Building Leverage CLI"
          git fetch origin ${{ inputs.leverage_branch }}:$(echo "${{ inputs.leverage_branch }}" | tr '/' '-')
          git checkout $(echo "${{ inputs.leverage_branch }}" | tr '/' '-')
          if ! (which pipenv 2>/dev/null); then echo 'Installing pipenv...' && pip install pipenv && pipenv --python $(which python) ; else echo 'pipenv is already installed'; fi
          make build
          pip install -e .
        working-directory: ./leverage

      - name: Set Leverage Toolbox version
        run: |
          printf "[INFO] Setting Leverage Toolbox version"
          TOOLBOX_VERSION=$(grep "__toolbox_version__" leverage/__init__.py | sed -E 's/__toolbox_version__ += "([0-9a-z\.\-]+)"/\1/')
          if [[ "$TOOLBOX_VERSION" != "" ]];
          then
              echo "Using version $TOOLBOX_VERSION";
              sed -E -i 's/^TERRAFORM_IMAGE_TAG=.+$/TERRAFORM_IMAGE_TAG='$TOOLBOX_VERSION'/' ../build.env;
          else
              echo "No version found"
          fi
        working-directory: ./leverage

      - name: Set up credentials
        run: |
          printf "[INFO] Setting up credentials"
          echo ${{ secrets.AWS_ACCESS_KEY_ID }} > pirulo.txt
          echo ${{ secrets.AWS_DEVSTG_ACCOUNT_ID }} >> pirulo.txt
          mkdir -p  ~/.aws/bb
          cat << EOF > ~/.aws/bb/credentials
          [bb-apps-devstg-devops]
          aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          EOF
          cat pirulo.txt

      - name: Test Reference Architecture
        run: |
          # These are later mounted in the container
          mkdir ~/.ssh && touch ~/.gitconfig

          printf "[INFO] Initializing layer"
          leverage tf init

          printf "[INFO] Generating plan"
          leverage tf plan

          printf "[INFO] Applying changes"
          leverage tf apply -auto-approve

          printf "[INFO] Checking if all changes were applied"
          leverage tf plan -detailed-exitcode
          [[ $? -eq 2 ]] && printf "[WARN] There are still remaining changes"
          [[ $? -eq 0 ]] && printf "[INFO] Apply checks out"

          printf "[INFO] Destroying all generated created resources"
          leverage tf destroy -auto-approve
        working-directory: ./apps-devstg/global/cli-test-layer

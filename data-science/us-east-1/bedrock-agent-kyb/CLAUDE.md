# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Layer Overview

This is the **Bedrock KYB Agent layer** within the Binbash Leverage Reference Architecture, located at `data-science/us-east-1/bedrock-agent-kyb`. It implements a document processing pipeline that combines AWS Bedrock Data Automation (BDA) with a Bedrock Agent for Know Your Business (KYB) document extraction and analysis.

## Essential Commands

### Infrastructure Deployment
```bash
# Navigate to the layer directory (REQUIRED)
cd data-science/us-east-1/bedrock-agent-kyb

# Initialize and validate
leverage tf init
leverage tf validate
leverage tf format

# Plan and review changes
leverage tf plan

# Apply infrastructure
leverage tf apply

# Destroy infrastructure (when needed)
leverage tf destroy
```

### Development Workflow
```bash
# After modifying Lambda code or schemas:
leverage tf plan -target=aws_lambda_function.bda_invoker -target=aws_lambda_function.agent_invoker

# Apply Lambda changes only
leverage tf apply -target=aws_lambda_function.bda_invoker -target=aws_lambda_function.agent_invoker -auto-approve
```

### Git Commit Guidelines
- **Clean commit messages**: Use standard conventional commit format
- **No AI watermarks**: Never add "Co-Authored-By: Claude" or "Generated with Claude Code" signatures
- **No Claude Code references**: Avoid any mentions of Claude Code, AI assistance, or copilot signatures
- **Professional format**: Commit messages should appear as if written by human developers
- **Focus on changes**: Describe what was implemented, not how it was created

## Architecture Overview

### Event-Driven Pipeline
The layer implements a 6-step document processing pipeline:
1. **PDF Upload** → Input S3 Bucket
2. **EventBridge** → BDA Invoker Lambda → BDA Project
3. **BDA Processing** → Standard Output → Processing S3 Bucket
4. **EventBridge** → Agent Invoker Lambda → Bedrock Agent (with session parameters)
5. **Agent Processing** → GetDocuments Lambda → Processing Bucket
6. **Agent Completion** → SaveDocument Lambda → Output Bucket

### Key Components
- **3 S3 Buckets**: Input (PDF uploads), Processing (BDA output), Output (final results)
- **4 Lambda Functions**: BDA Invoker, Agent Invoker, GetDocuments, SaveDocument
- **2 EventBridge Rules**: Input bucket trigger, Processing bucket trigger
- **Bedrock Resources**: BDA Project (standard output), Bedrock Agent (session parameters)

### File Structure
```
bedrock-agent-kyb/
├── specs/                  # Specification files
│   ├── requirements.md     # Use cases and functional requirements
│   ├── design.md          # Component design and data flow
│   └── tasks.md           # Implementation tasks
├── src/                   # Lambda source code
│   ├── lambda/            # Lambda function handlers
│   └── schemas/           # Action group OpenAPI schemas
├── config.tf              # Provider and backend configuration
├── locals.tf              # Local variables and naming
├── variables.tf           # Input variables
├── outputs.tf             # Layer outputs
├── s3.tf                  # S3 buckets and policies
├── bedrock.tf             # BDA project and Bedrock Agent
├── lambda.tf              # Lambda functions and layers
├── eventbridge.tf         # EventBridge rules and targets
└── iam.tf                 # IAM roles and policies
```

## Critical Implementation Requirements

### Minimal Implementation Principle
This layer follows **DRY, KISS, and YAGNI principles** with strict requirements:
- **No boilerplate code** - Every line must serve a specific requirement
- **No error handling** beyond basic AWS SDK defaults
- **No logging** beyond minimal operational needs
- **Minimal comments** - Only when necessary for clarity (e.g., progressive implementation patterns)
- **No testing frameworks** or monitoring features
- **No defensive programming** patterns

### Comment Guidelines
- Use comments sparingly and only when needed for clarity
- Comments should explain WHY, not WHAT
- Acceptable scenarios: progressive implementation patterns, non-obvious design decisions, temporary workarounds
- Prefer self-documenting code over excessive documentation

### BDA Configuration
- Uses **standard output** configuration (not custom blueprints)
- Standard output saves OCR extraction in different folder structure
- BDA Project processes PDF documents with built-in document extraction

### Agent Session Parameters
- Agent uses **session parameters** to automatically inject parameters to action groups
- `output_type`: "Standard" - determines folder structure for document retrieval
- `correlation_id`: Generated by BDA Invoker Lambda for end-to-end tracking
- Session parameters avoid explicit parameter passing between agent and action groups

### Action Group Design
- **GetDocuments**: Retrieves BDA processed documents from processing bucket using standard output structure
- **SaveDocument**: Saves agent results to output bucket maintaining correlation ID
- Both action groups receive session parameters automatically

## Data Flow and Correlation
- **Correlation ID** generated at BDA invocation maintains traceability across entire pipeline
- **Standard Output Structure** from BDA determines how GetDocuments retrieves files
- **Session Parameters** eliminate need for manual parameter passing between components
- **EventBridge triggers** orchestrate the workflow without manual intervention

## Integration Points
This layer is designed as a **self-contained reference implementation** that can be deployed independently without dependencies on other layers. It demonstrates the integration pattern of BDA + Bedrock Agent for document processing workflows in the Leverage Reference Architecture.